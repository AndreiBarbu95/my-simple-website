version: v1.1.0
steps:
  # Build target image
- build: -t {{.Run.Registry}}/simple:{{.Run.ID}} -f Dockerfile .

  # Run image 
- cmd: -t {{.Run.Registry}}/hello-world:{{.Run.ID}}
  id: test
  detach: true
  ports: ["8080:80"]

  # Stop the container and print container ID
- cmd: |
      container_id=$(docker ps -aqf "name=test")
      docker stop "${container_id}"
      echo "The container with ID ${container_id} was stopped"

  # Push image
- push:
  - {{.Run.Registry}}/simple:{{.Run.ID}}
