version: v1.1.0
steps:
  # Build target image
  - build:
      dockerfile: Dockerfile 
      image: "{{.Run.Registry}}/simple:{{.Run.ID}}"

  # Run image 
  - cmd:
      image: "{{.Run.Registry}}/simple:{{.Run.ID}}"
      detach: true
      ports: ["8080:80"]
    id: test

  # Stop the container and print container ID
  - cmd: |
      container_id=$(docker ps -aqf "name=test")
      docker stop "${container_id}"
      echo "Container ID: $container_id"
    displayName: 'Stop and Print Container ID'

  # Push image
  - push:
      images: "{{.Run.Registry}}/simple:{{.Run.ID}}"
